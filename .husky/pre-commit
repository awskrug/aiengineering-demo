#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ë³€ê²½ëœ íŒŒì¼ í™•ì¸
CHANGED_FILES=$(git diff --cached --name-only)

# í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ í™•ì¸
FRONTEND_CHANGED=false
for file in $CHANGED_FILES; do
  if [[ $file == frontend/* ]]; then
    FRONTEND_CHANGED=true
    break
  fi
done

# ë°±ì—”ë“œ ë³€ê²½ í™•ì¸
BACKEND_CHANGED=false
for file in $CHANGED_FILES; do
  if [[ $file == backend/* ]]; then
    BACKEND_CHANGED=true
    break
  fi
done

# ë³€ê²½ëœ ë¶€ë¶„ì— ë”°ë¼ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
if [ "$FRONTEND_CHANGED" = true ]; then
  echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ ê°ì§€: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
  cd frontend && npm run build && npm test
  if [ $? -ne 0 ]; then
    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    exit 1
  fi
  echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ"
  cd ..
fi

if [ "$BACKEND_CHANGED" = true ]; then
  echo "ğŸ” ë°±ì—”ë“œ ë³€ê²½ ê°ì§€: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
  cd backend && npm run build && npm test
  if [ $? -ne 0 ]; then
    echo "âŒ ë°±ì—”ë“œ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    exit 1
  fi
  echo "âœ… ë°±ì—”ë“œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ"
  cd ..
fi

# lint-staged ì‹¤í–‰ (ì¶”ê°€ì ì¸ ë¦°íŒ… ì‘ì—…ì´ í•„ìš”í•œ ê²½ìš°)
npx lint-staged
