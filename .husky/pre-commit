#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ë³€ê²½ëœ íŒŒì¼ í™•ì¸
CHANGED_FILES=$(git diff --cached --name-only)

# í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ í™•ì¸
FRONTEND_CHANGED=false
for file in $CHANGED_FILES; do
  if [[ $file == frontend/* ]]; then
    FRONTEND_CHANGED=true
    break
  fi
done

# ë°±ì—”ë“œ ë³€ê²½ í™•ì¸
BACKEND_CHANGED=false
for file in $CHANGED_FILES; do
  if [[ $file == backend/* ]]; then
    BACKEND_CHANGED=true
    break
  fi
done

# í…Œë¼í¼ ë³€ê²½ í™•ì¸
TERRAFORM_CHANGED=false
for file in $CHANGED_FILES; do
  if [[ $file == terraform/*.tf ]]; then
    TERRAFORM_CHANGED=true
    break
  fi
done

# ë³€ê²½ëœ ë¶€ë¶„ì— ë”°ë¼ ë¦°íŠ¸, ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
if [ "$FRONTEND_CHANGED" = true ]; then
  echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ ê°ì§€: ë¦°íŠ¸ ìë™ ìˆ˜ì •, ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
  cd frontend && npm run lint:fix
  # ìˆ˜ì •ëœ íŒŒì¼ë“¤ì„ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
  cd .. && git add frontend/
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  cd frontend && npm run build && npm test
  if [ $? -ne 0 ]; then
    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    exit 1
  fi
  echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¦°íŠ¸ ìë™ ìˆ˜ì •, ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ"
  cd ..
fi

if [ "$BACKEND_CHANGED" = true ]; then
  echo "ğŸ” ë°±ì—”ë“œ ë³€ê²½ ê°ì§€: ë¦°íŠ¸ ìë™ ìˆ˜ì •, ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
  cd backend && npm run lint:fix
  # ìˆ˜ì •ëœ íŒŒì¼ë“¤ì„ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
  cd .. && git add backend/
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  cd backend && npm run build && npm test
  if [ $? -ne 0 ]; then
    echo "âŒ ë°±ì—”ë“œ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    exit 1
  fi
  echo "âœ… ë°±ì—”ë“œ ë¦°íŠ¸ ìë™ ìˆ˜ì •, ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ"
  cd ..
fi

if [ "$TERRAFORM_CHANGED" = true ]; then
  echo "ğŸ” í…Œë¼í¼ ë³€ê²½ ê°ì§€: ì˜ì¡´ê´€ê³„ ê·¸ë˜í”„ ìƒì„± ì¤‘..."
  cd terraform && ./generate_graph.sh
  if [ $? -ne 0 ]; then
    echo "âŒ í…Œë¼í¼ ê·¸ë˜í”„ ìƒì„± ì‹¤íŒ¨"
    exit 1
  fi
  git add terraform/graphs/terraform_graph.png terraform/graphs/terraform_graph.svg
  echo "âœ… í…Œë¼í¼ ê·¸ë˜í”„ ìƒì„± ì„±ê³µ"
  cd ..
fi

# lint-staged ì‹¤í–‰ (ì¶”ê°€ì ì¸ ë¦°íŒ… ì‘ì—…ì´ í•„ìš”í•œ ê²½ìš°)
npx lint-staged
